<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="In loving memory of Ruth Tomlinson-Brown (1931-2026). A celebration of a life well lived.">
    <title>In Loving Memory | Ruth Tomlinson-Brown</title>
    
    <!-- Open Graph / Facebook / SMS Sharing Tags (CRITICAL FIX) -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://ruthtomlinsonbrown.netlify.app">
    <meta property="og:title" content="In Loving Memory | Ruth Tomlinson-Brown">
    <meta property="og:description" content="July 18, 1931 - January 14, 2026. Join us in celebrating the life of a beloved mother, grandmother, and community pillar.">
    <!-- Note: Replace with absolute URL to hosted image for production -->
    <meta property="og:image" content="https://images.unsplash.com/photo-1511895426328-dc8714191300?w=1200"> 

    <!-- Premium Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,opsz,wght@0,6..96,400;0,6..96,500;1,6..96,400&family=Inter:wght@300;400;500;600&family=Pinyon+Script&display=swap" rel="stylesheet">

    <!-- HEIC to JPEG conversion for Apple photos -->
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>

    <style>
        :root {
            --bg-base: #FDFCFB;
            --bg-warm: #F7F3F0;
            --text-primary: #2D2A26;
            /* ACCESSIBILITY FIX: Darkened from #5E5852 for better contrast */
            --text-muted: #4A4540; 
            --accent: #A68B67;
            --accent-light: #E8E2DA;
            --font-serif: 'Bodoni Moda', serif;
            --font-sans: 'Inter', sans-serif;
            --font-script: 'Pinyon Script', cursive;
            --transition-smooth: all 0.7s cubic-bezier(0.16, 1, 0.3, 1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        /* UX FIX: scroll-padding ensures headers aren't hidden by sticky nav */
        html { scroll-behavior: smooth; scroll-padding-top: 80px; font-size: 16px; }
        
        body { background-color: var(--bg-base); color: var(--text-primary); font-family: var(--font-sans); line-height: 1.6; -webkit-font-smoothing: antialiased; }

        h1, h2, h3 { font-family: var(--font-serif); font-weight: 400; letter-spacing: -0.01em; }
        h1 { font-size: clamp(3.2rem, 8vw, 5.5rem); line-height: 0.95; margin-bottom: 1.5rem; }
        h2 { font-size: clamp(2.2rem, 5vw, 3rem); margin-bottom: 2rem; text-align: center; }
        
        .script-hero { font-family: var(--font-script); font-size: clamp(2rem, 4.5vw, 3rem); color: var(--accent); margin-bottom: 0.5rem; }
        .label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.3em; color: var(--accent); font-weight: 600; display: block; margin-bottom: 1.5rem; text-align: center; }

        .section { padding: 8rem 0; position: relative; }
        .container { width: 90%; margin: 0 auto; position: relative; z-index: 2; }
        .container-sm { max-width: 720px; }
        .container-md { max-width: 960px; }

        /* NEW: STICKY NAVIGATION */
        .sticky-nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(253, 252, 251, 0.95);
            backdrop-filter: blur(10px);
            padding: 1.2rem 0;
            z-index: 1000;
            transform: translateY(-100%);
            transition: transform 0.4s ease;
            box-shadow: 0 2px 20px rgba(0,0,0,0.05);
            border-bottom: 1px solid rgba(166, 139, 103, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2.5rem;
        }
        .sticky-nav.visible { transform: translateY(0); }
        .nav-link {
            font-family: var(--font-sans);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            font-size: 0.75rem;
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
            position: relative;
        }
        .nav-link:hover { color: var(--accent); }
        .nav-link::after {
            content: ''; position: absolute; bottom: -5px; left: 0; width: 0; height: 1px; background: var(--accent); transition: width 0.3s ease;
        }
        .nav-link:hover::after { width: 100%; }

        /* HERO */
        .hero { min-height: 100vh; display: flex; align-items: center; justify-content: center; text-align: center; background-color: var(--bg-warm); padding: 4rem 0; }
        .hero-img-box { width: clamp(280px, 40vw, 380px); height: clamp(350px, 50vw, 480px); margin: 0 auto 3rem; border-radius: 200px 200px 20px 20px; overflow: hidden; box-shadow: 0 30px 60px -15px rgba(0,0,0,0.15); border: 8px solid white; }
        .hero-img-box img { width: 100%; height: 100%; object-fit: cover; object-position: top center; }
        .hero-dates { font-family: var(--font-serif); font-size: 1.4rem; font-style: italic; color: var(--text-muted); margin: 2rem 0; display: flex; justify-content: center; align-items: center; gap: 2rem; }
        .hero-dates span { width: 40px; height: 1px; background: var(--accent-light); }

        /* OBITUARY REFINEMENTS */
        .obituary-text { font-size: 1.2rem; color: var(--text-muted); text-align: justify; line-height: 1.8; }
        .obituary-text p { margin-bottom: 2rem; }
        .dropcap { float: left; font-family: var(--font-serif); font-size: 5.5rem; line-height: 0.7; padding: 10px 18px 0 0; color: var(--accent); }

        .pull-quote {
            margin: 4rem 0;
            padding: 3rem 0;
            border-top: 1px solid var(--accent-light);
            border-bottom: 1px solid var(--accent-light);
            text-align: center;
        }
        .pull-quote blockquote {
            font-family: var(--font-serif);
            font-size: 2rem;
            font-style: italic;
            color: var(--accent);
            line-height: 1.3;
        }
        .pull-quote cite {
            display: block;
            margin-top: 1rem;
            font-family: var(--font-sans);
            font-style: normal;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: var(--text-muted);
        }

        /* SERVICE CARDS WITH TEXTURE */
        .service-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 2rem; margin-top: 4rem; }
        .card { 
            background: white; 
            padding: 4rem 2rem; 
            border-radius: 4px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.03); 
            text-align: center; 
            border: 1px solid var(--accent-light);
            position: relative;
            overflow: hidden;
        }
        /* Subtle floral watermark effect */
        .card::before {
            content: '✿';
            position: absolute;
            bottom: -20px;
            right: -10px;
            font-size: 8rem;
            opacity: 0.03;
            color: var(--accent);
        }

        /* PALLBEARERS SECTION */
        .pallbearers-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4rem;
            margin-top: 3rem;
            text-align: center;
        }
        .pallbearer-list { list-style: none; color: var(--text-muted); font-family: var(--font-serif); font-size: 1.1rem; line-height: 2.2; }
        .pallbearer-list li { border-bottom: 1px solid #f0f0f0; margin-bottom: 0.5rem; padding-bottom: 0.5rem; }
        .pallbearer-list li:last-child { border: none; }

        /* GALLERY MASONRY */
        .gallery-masonry { columns: 3 250px; column-gap: 1.5rem; margin-top: 3rem; }
        .gallery-item { break-inside: avoid; margin-bottom: 1.5rem; border-radius: 8px; overflow: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.05); background: var(--accent-light); }
        .gallery-item img { width: 100%; display: block; filter: grayscale(15%); transition: var(--transition-smooth); }
        .gallery-item:hover img { filter: grayscale(0%); transform: scale(1.05); }

        /* BUTTONS & FORMS */
        .btn { 
            display: inline-block; 
            padding: 1.1rem 2.8rem; 
            background: var(--accent); 
            color: white; 
            border: none; 
            border-radius: 50px; 
            cursor: pointer; 
            text-transform: uppercase; 
            font-size: 0.85rem; 
            letter-spacing: 0.2em; 
            transition: var(--transition-smooth); 
            text-decoration: none; 
            box-shadow: 0 10px 20px -5px rgba(166, 139, 103, 0.4);
        }
        .btn:hover { background: var(--text-primary); transform: translateY(-3px); box-shadow: 0 15px 30px -5px rgba(0,0,0,0.2); }

        .upload-zone { 
            border: 2px dashed var(--accent-light); 
            padding: 4rem 2rem; 
            text-align: center; 
            border-radius: 12px; 
            cursor: pointer; 
            transition: var(--transition-smooth); 
            background: var(--bg-warm);
        }
        .upload-zone:hover { border-color: var(--accent); background: #fff; }

        /* POEMS */
        .poems-wrap { background-color: var(--bg-warm); padding: 10rem 0; border-top: 1px solid var(--accent-light); }
        .poem-content { font-family: var(--font-serif); font-size: 1.35rem; line-height: 2.4; font-style: italic; white-space: pre-line; color: var(--text-muted); }

        /* NEW ACCORDION STYLES FOR POEMS */
        .accordion { max-width: 800px; margin: 0 auto; }
        .accordion-item { border-bottom: 1px solid var(--accent-light); margin-bottom: 1rem; }
        .accordion-header {
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            padding: 1.5rem 0;
            font-family: var(--font-serif);
            font-size: clamp(1.4rem, 4vw, 1.8rem);
            color: var(--accent);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: color 0.3s ease;
        }
        .accordion-header:hover { color: var(--text-primary); }
        .accordion-icon { font-size: 1.5rem; transition: transform 0.3s ease; }
        .accordion-item.active .accordion-icon { transform: rotate(45deg); }
        
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s cubic-bezier(0, 1, 0, 1);
            opacity: 0;
            transform: translateY(10px);
        }
        .accordion-item.active .accordion-content {
            /* Open state is handled by JS setting max-height */
            opacity: 1;
            transform: translateY(0);
            transition: all 0.5s ease;
            padding-bottom: 2rem;
        }

        .reveal { opacity: 0; transform: translateY(40px); transition: var(--transition-smooth); }
        .reveal.active { opacity: 1; transform: translateY(0); }

        @media (max-width: 768px) { 
            .gallery-masonry { columns: 2 150px; } 
            .section { padding: 5rem 0; }
            h1 { font-size: 3.5rem; }
            .obituary-text { text-align: left; font-size: 1.1rem; }
            .pallbearers-grid { grid-template-columns: 1fr; gap: 2rem; }
            .pull-quote blockquote { font-size: 1.5rem; }
            
            /* Responsive Nav */
            .sticky-nav { gap: 1.2rem; padding: 1rem 0; }
            .nav-link { font-size: 0.65rem; letter-spacing: 0.1em; }
        }
    </style>
</head>
<body>

    <!-- STICKY NAV -->
    <nav class="sticky-nav" id="sticky-nav">
        <a href="#obituary" class="nav-link">Life Story</a>
        <a href="#service" class="nav-link">Service</a>
        <a href="#gallery" class="nav-link">Gallery</a>
        <a href="#tributes" class="nav-link">Tributes</a>
    </nav>

    <!-- HERO -->
    <header class="hero" id="home">
        <div class="container reveal">
            <div class="hero-img-box">
                <!-- Using placeholder for demo purposes -->
                <img src="grandmother in pink sweater.png" alt="Ruth Tomlinson-Brown">
            </div>
            <p class="script-hero">Celebrating the life of</p>
            <h1>Ruth Tomlinson-Brown</h1>
            <div class="hero-dates">
                July 18, 1931 <span></span> January 14, 2026
            </div>
        </div>
    </header>

    <!-- OBITUARY -->
    <section class="section" id="obituary">
        <div class="container container-sm">
            <span class="label reveal">The Story of Ruth</span>
            <h2 class="reveal">A Journey of Compassion</h2>
            <div class="obituary-text reveal">
                <p><span class="dropcap">R</span>uth Tomlinson-Brown was born on July 18, 1931, in Wilmington, Delaware, to Willard and Ruth Wilson. The second of three children, Ruth spent her early years in Delaware, where she began building the compassion, strength, and sense of responsibility that would define her life. She passed away peacefully in her sleep on January 14, 2026, in California, at the age of 94.</p>
                
                <p>As a young woman, Ruth married Harvey "Tommy" Tomlinson, and together they started a family. In the early 1960s, the family relocated to California when Harvey was transferred to Castle Air Force Base in Atwater. California would become Ruth's permanent home for more than five decades. Merced became the community she served for decades, as she showed up, again and again, for her family and her community.</p>

                <!-- Pull Quote to break up text -->
                <div class="pull-quote reveal">
                    <blockquote>"Affectionately known as Triple G, her home was a place of warmth, laughter, and always enough food for anyone who walked through the door."</blockquote>
                    <cite>A Legacy of Love</cite>
                </div>

                <p>Ruth began her career in healthcare as a Nurse's Aide—now known as a Certified Nursing Assistant (CNA). In 1962, she started working at General Hospital, later known as Mercy Medical Center, where she served for 28 years until her retirement in 1990. She took pride in caring for others and left a lasting impression on colleagues, patients, and families alike.</p>

                <p>Service extended far beyond Ruth's professional life. She was deeply involved in her community, advocating for children's scholarships, urging city leaders to improve neighborhood infrastructure, and supporting political candidates who championed the needs of the people. Ruth was a longtime, dedicated member of the Second Baptist Church, where she found strength in her faith and built a network of lifelong friends. She lived her faith through action, acting as a second mother to many children in her community through foster care and neighborhood guidance.</p>

                <p>Affectionately known as "Triple G" (Great-Great Grandmother), Ruth's greatest joy was her expansive, loving family. She was a pillar of strength, a source of wisdom, and a beacon of love for five generations. Ruth's legacy of service, faith, and family will continue to inspire those who knew her.</p>
            </div>
        </div>
    </section>

    <!-- SUPPORT -->
    <section class="section" style="padding-top: 0;">
        <div class="container container-sm">
            <div class="support-card reveal">
                <span class="label">Honoring Her Legacy</span>
                <h3>Memorial Fund</h3>
                <p style="color: var(--text-muted); margin: 1.5rem 0 2rem;">In lieu of flowers, the family would appreciate contributions toward memorial expenses to help honor Ruth's remarkable 94 years of life.</p>
                
                <!-- GoFundMe Widget -->
                <div style="max-width: 400px; margin: 0 auto; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden;">
                    <div class="gfm-embed" data-url="https://www.gofundme.com/f/honoring-ruth-with-a-loving-farewell/widget/medium?sharesheet=undefined&attribution_id=sl:694e5d6b-740e-4c18-b639-a61a8646746c"></div>
                    <script src="https://www.gofundme.com/static/js/embed.js"></script>
                </div>

            </div>
        </div>
    </section>

    <!-- SERVICE & PALLBEARERS -->
    <section class="section" id="service" style="background-color: #fff;">
        <div class="container container-md">
            <span class="label reveal">The Homegoing</span>
            <h2 class="reveal">Service & Remembrance</h2>
            
            <div class="service-grid reveal">
                <div class="card">
                    <span style="color: var(--accent); font-weight: 600; font-size: 0.9rem;">THE SERVICE</span>
                    <h3>Celebration of Life</h3>
                    <p>Friday, February 6, 2026<br>1:00 PM</p>
                    <p style="margin-top: 1.5rem;"><strong>Christian Life Center</strong><br>650 E. Olive Avenue<br>Merced, CA 95340</p>
                    <!-- Added Google Maps Link -->
                    <a href="https://www.google.com/maps/dir/?api=1&destination=Christian+Life+Center+650+E.+Olive+Avenue+Merced+CA+95340" target="_blank" style="display: inline-block; margin-top: 1.2rem; color: var(--accent); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.15em; text-decoration: none; border-bottom: 1px solid rgba(166, 139, 103, 0.3); padding-bottom: 2px;">
                        Get Directions &rarr;
                    </a>
                </div>
                <div class="card">
                    <span style="color: var(--accent); font-weight: 600; font-size: 0.9rem;">GATHERING</span>
                    <h3>The Repast</h3>
                    <p>Following the Service</p>
                    <p style="margin-top: 1.5rem;"><strong>Fellowship Hall</strong><br>Christian Life Center</p>
                </div>
            </div>

            <!-- New Pallbearers Section -->
            <div style="margin-top: 8rem;" class="reveal">
                <span class="label">Honored Attendants</span>
                <div class="pallbearers-grid">
                    <div>
                        <h3 style="margin-bottom: 2rem; font-style: italic;">Pallbearers</h3>
                        <ul class="pallbearer-list">
                            <li>Roger Tomlinson, Jr.</li>
                            <li>Camron Griffin</li>
                            <li>Darnell Tomlinson</li>
                            <li>Brian Tomlinson</li>
                            <li>Virgil Broughton</li>
                            <li>Shawn Tomlinson</li>
                        </ul>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 2rem; font-style: italic;">Honorary Pallbearers</h3>
                        <ul class="pallbearer-list">
                            <li>Abbayael Isreal</li>
                            <li>Antione Hubbard</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Video Tribute -->
            <div style="width: 100%; max-width: 900px; margin: 8rem auto 0; border-radius: 12px; overflow: hidden; box-shadow: 0 40px 80px -20px rgba(0,0,0,0.2);" class="reveal">
                <div style="position: relative; padding-bottom: 56.25%; height: 0;">
                    <iframe style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" src="https://www.youtube.com/embed/z6mH4ccl9u0" title="Ruth Tribute" allowfullscreen></iframe>
                </div>
            </div>
        </div>
    </section>

    <!-- GALLERY & UPLOAD -->
    <section class="section" id="gallery">
        <div class="container container-md">
            <span class="label reveal">The Photo Archive</span>
            <h2 class="reveal">Moments of Joy</h2>

            <div id="gallery-loading" class="reveal" style="text-align: center; padding: 3rem; color: var(--text-muted);">
                <p>Loading family memories...</p>
            </div>

            <div class="gallery-masonry reveal" id="gallery-grid" style="display: none;">
                <!-- Photos will be loaded dynamically from R2 -->
            </div>

            <div id="gallery-empty" class="reveal" style="display: none; text-align: center; padding: 3rem; color: var(--text-muted);">
                <p>No photos yet. Be the first to share a memory!</p>
            </div>

            <!-- Link to view all uploads in full gallery -->
            <div class="reveal" style="text-align: center; margin-top: 3rem;">
                <a href="https://family-archive-vault-production.up.railway.app/gallery" target="_blank" class="btn">
                    View Full Gallery →
                </a>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 1rem;">See all photos and videos with slideshow feature</p>
            </div>

            <div class="form-card reveal" style="margin-top: 5rem;">
                <div style="text-align: center; margin-bottom: 2.5rem;">
                    <h3 style="font-size: 1.8rem;">Add to the Legacy</h3>
                    <p style="color: var(--text-muted); font-size: 1rem; max-width: 500px; margin: 0.5rem auto;">Help us preserve Ruth's memory by uploading your favorite photos and videos.</p>
                </div>

                <div class="upload-zone" onclick="document.getElementById('photo-input').click()">
                    <input type="file" id="photo-input" hidden multiple accept="image/*,video/*">
                    <p style="font-size: 1.1rem;"><strong>Tap here to select photos or videos</strong></p>
                    <p style="font-size: 0.85rem; margin-top: 0.5rem; opacity: 0.7;">Upload from your camera roll or computer</p>
                </div>
                <div id="upload-feedback" style="display:none; text-align: center; margin-top: 1.5rem; color: var(--accent); font-weight: 500;"></div>
            </div>
        </div>
    </section>

    <!-- TRIBUTES -->
    <section class="section" id="tributes" style="background: white;">
        <div class="container container-sm">
            <span class="label reveal">Guestbook</span>
            <h2 class="reveal">Share a Memory</h2>
            <div class="form-card reveal">
                <form onsubmit="event.preventDefault(); document.getElementById('success-msg').style.display='block'; this.reset();">
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label class="form-label" style="display:block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">Your Name</label>
                        <input type="text" class="form-input" required placeholder="Full Name" style="width: 100%; padding: 1rem; border: 1px solid var(--accent-light); border-radius: 4px; font-family: var(--font-sans);">
                    </div>
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label class="form-label" style="display:block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">Message</label>
                        <textarea class="form-input" rows="6" required placeholder="Share a special memory or message..." style="width: 100%; padding: 1rem; border: 1px solid var(--accent-light); border-radius: 4px; font-family: var(--font-sans);"></textarea>
                    </div>
                    <div style="text-align: center;">
                        <button type="submit" class="btn">Send Tribute</button>
                    </div>
                    <p id="success-msg" style="display:none; color: var(--accent); margin-top: 1.5rem; font-size: 1rem; text-align: center;">Thank you. Your message has been sent to the family.</p>
                </form>
            </div>
        </div>
    </section>

    <!-- POEMS (Redesigned as Accordion) -->
    <section class="section poems-wrap">
        <div class="container container-sm">
            <span class="label reveal">Reflections</span>
            <h2 class="reveal" style="margin-bottom: 3rem;">In Her Memory</h2>
            
            <div class="accordion reveal">
                <!-- Poem 1 -->
                <div class="accordion-item">
                    <button class="accordion-header" onclick="toggleAccordion(this)">
                        <span>When Tomorrow Starts Without Me</span>
                        <span class="accordion-icon">+</span>
                    </button>
                    <div class="accordion-content">
                        <div class="poem-content">
                            When tomorrow starts without me,
                            And I’m not there to see;
                            If the sun should rise and find your eyes
                            All filled with tears for me.
                            I wish so much you wouldn’t cry
                            The way you did today;
                            While thinking of the many things
                            We didn’t get to say.

                            I know how much you love me,
                            As much as I love you;
                            And each time that you think of me,
                            I know you’ll miss me too.
                            But when tomorrow starts without me,
                            Please try to understand,
                            That an angel came and called my name,
                            And took me by the hand.
                        </div>
                    </div>
                </div>

                <!-- Poem 2 (New Addition) -->
                <div class="accordion-item">
                    <button class="accordion-header" onclick="toggleAccordion(this)">
                        <span>Do Not Stand at My Grave and Weep</span>
                        <span class="accordion-icon">+</span>
                    </button>
                    <div class="accordion-content">
                        <div class="poem-content">
                            Do not stand at my grave and weep
                            I am not there. I do not sleep.
                            I am a thousand winds that blow.
                            I am the diamond glints on snow.
                            I am the sunlight on ripened grain.
                            I am the gentle autumn rain.

                            When you awaken in the morning's hush
                            I am the swift uplifting rush
                            Of quiet birds in circled flight.
                            I am the soft stars that shine at night.
                            Do not stand at my grave and cry;
                            I am not there. I did not die.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ACKNOWLEDGEMENTS -->
    <section class="section thanks-section">
        <div class="container container-sm reveal" style="text-align: center;">
            <span class="label">Acknowledgements</span>
            <p class="thanks-text" style="color: var(--text-muted); font-size: 1.1rem; line-height: 1.8;">
                The family of Ruth Tomlinson-Brown wishes to express our deepest gratitude for the many acts of kindness, comforting messages, and prayers during our time of bereavement. Your love has been a source of great strength. May God continue to bless each of you.
            </p>
        </div>
    </section>

    <footer class="footer" style="padding: 6rem 0; background: var(--text-primary); color: white; text-align: center;">
        <div class="container">
            <div class="footer-logo" style="font-family: var(--font-script); font-size: 3rem; margin-bottom: 1rem;">Ruth Tomlinson-Brown</div>
            <p style="opacity: 0.6; font-family: var(--font-serif); font-style: italic; font-size: 1.2rem;">"Well done, my good and faithful servant."</p>
            <p style="font-size: 0.75rem; letter-spacing: 0.3em; opacity: 0.4; margin-top: 4rem; font-weight: 300;">© 2026 THE TOMLINSON-BROWN FAMILY</p>
        </div>
    </footer>

    <script>
        // Reveal elements on scroll
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => { if (entry.isIntersecting) entry.target.classList.add('active'); });
        }, { threshold: 0.1 });
        document.querySelectorAll('.reveal').forEach(el => observer.observe(el));

        // ========== GALLERY LOADING ==========
        async function loadGallery() {
            const loadingEl = document.getElementById('gallery-loading');
            const gridEl = document.getElementById('gallery-grid');
            const emptyEl = document.getElementById('gallery-empty');

            try {
                const response = await fetch('/.netlify/functions/gallery');
                const data = await response.json();

                if (!data.success || !data.photos || data.photos.length === 0) {
                    loadingEl.style.display = 'none';
                    emptyEl.style.display = 'block';
                    return;
                }

                // Clear loading state
                loadingEl.style.display = 'none';
                gridEl.style.display = 'block';
                gridEl.innerHTML = '';

                // Add each photo to the gallery
                for (const photo of data.photos) {
                    const item = document.createElement('div');
                    item.className = 'gallery-item';

                    if (photo.isVideo) {
                        // Video element
                        item.innerHTML = `
                            <video src="${photo.url}" controls preload="metadata"
                                   style="width: 100%; display: block;">
                            </video>
                            <div style="padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">
                                From ${photo.contributor}
                            </div>
                        `;
                    } else if (photo.isHeic) {
                        // HEIC image - needs conversion
                        const img = document.createElement('img');
                        img.alt = `From ${photo.contributor}`;
                        img.style.width = '100%';
                        img.style.display = 'block';
                        img.dataset.heicUrl = photo.url;
                        img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="200"><rect fill="%23f0ebe5" width="300" height="200"/><text x="150" y="100" text-anchor="middle" fill="%23a68b67" font-size="14">Converting...</text></svg>';
                        item.appendChild(img);

                        // Convert HEIC in background
                        convertHeicImage(img, photo.url);
                    } else {
                        // Regular image
                        item.innerHTML = `<img src="${photo.url}" alt="From ${photo.contributor}" loading="lazy">`;
                    }

                    gridEl.appendChild(item);
                }

            } catch (error) {
                console.error('Failed to load gallery:', error);
                loadingEl.innerHTML = '<p>Failed to load photos. Please refresh the page.</p>';
            }
        }

        // Convert HEIC to displayable format
        async function convertHeicImage(imgElement, heicUrl) {
            try {
                const response = await fetch(heicUrl);
                const blob = await response.blob();

                const convertedBlob = await heic2any({
                    blob: blob,
                    toType: 'image/jpeg',
                    quality: 0.8
                });

                const jpegUrl = URL.createObjectURL(convertedBlob);
                imgElement.src = jpegUrl;
            } catch (error) {
                console.error('HEIC conversion failed:', error);
                imgElement.alt = 'Could not load image';
                imgElement.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="200"><rect fill="%23f0ebe5" width="300" height="200"/><text x="150" y="100" text-anchor="middle" fill="%23c44" font-size="12">Could not load</text></svg>';
            }
        }

        // Load gallery on page load
        loadGallery();

        // Photo Upload Handling - Real upload to Family Archive
        // Supports both small files (via Netlify function) and large files (direct to R2)
        const photoInput = document.getElementById('photo-input');
        const feedback = document.getElementById('upload-feedback');

        // Size threshold for direct upload (4MB - lowered to avoid Netlify limits)
        const DIRECT_UPLOAD_THRESHOLD = 4 * 1024 * 1024;

        // Compute a hash of file content for deduplication
        async function computeFileHash(file) {
            const buffer = await file.arrayBuffer();
            const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            // Return first 12 hex chars (6 bytes) - enough for deduplication
            return hashArray.slice(0, 6).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Upload small files through Netlify function
        async function uploadSmallFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('contributor', 'Memorial_Guest');

            const response = await fetch('/.netlify/functions/upload', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Upload failed');
            }

            return await response.json();
        }

        // Upload large files directly to R2 using presigned URL
        async function uploadLargeFile(file, onProgress, fileHash) {
            // Step 1: Get presigned URL from Netlify function
            const urlResponse = await fetch('/.netlify/functions/get-upload-url', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    filename: file.name,
                    contentType: file.type || 'application/octet-stream',
                    size: file.size,
                    fileHash: fileHash // Send hash for deduplication
                })
            });

            if (!urlResponse.ok) {
                const error = await urlResponse.json();
                throw new Error(error.error || 'Failed to get upload URL');
            }

            const data = await urlResponse.json();

            // Check if file was skipped as duplicate
            if (data.skipped) {
                console.log('Skipped duplicate:', data.objectKey);
                return { objectKey: data.objectKey, size: file.size, skipped: true };
            }

            const { uploadUrl, objectKey } = data;

            // Step 2: Upload directly to R2 using presigned URL
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();

                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable && onProgress) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        onProgress(percent);
                    }
                });

                xhr.addEventListener('load', () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        console.log('Uploaded:', objectKey);
                        resolve({ objectKey, size: file.size });
                    } else {
                        reject(new Error('Upload failed with status ' + xhr.status));
                    }
                });

                xhr.addEventListener('error', () => {
                    reject(new Error('Network error during upload'));
                });

                xhr.addEventListener('abort', () => {
                    reject(new Error('Upload was cancelled'));
                });

                xhr.open('PUT', uploadUrl);
                xhr.setRequestHeader('Content-Type', file.type || 'application/octet-stream');
                xhr.send(file);
            });
        }

        photoInput.addEventListener('change', async (e) => {
            const files = e.target.files;
            if (files.length === 0) return;

            feedback.style.display = 'block';
            feedback.style.color = '#666';
            feedback.innerText = `Preparing ${files.length} file(s)...`;

            try {
                let uploaded = 0;
                let skipped = 0;
                const total = files.length;

                for (const file of files) {
                    // Compute hash for deduplication
                    feedback.innerText = `Checking ${file.name} (${uploaded + 1}/${total})...`;
                    const fileHash = await computeFileHash(file);

                    if (file.size > DIRECT_UPLOAD_THRESHOLD) {
                        // Large file: use presigned URL for direct upload
                        const result = await uploadLargeFile(file, (progress) => {
                            feedback.innerText = `Uploading ${file.name}: ${progress}%`;
                        }, fileHash);

                        if (result.skipped) {
                            skipped++;
                        }
                    } else {
                        // Small file: use Netlify function (hash checked server-side)
                        const result = await uploadSmallFile(file);
                        if (result.files && result.files[0] && result.files[0].skipped) {
                            skipped++;
                        }
                    }

                    uploaded++;
                }

                // Success message with skip info
                feedback.style.color = '#A68B67';
                if (skipped > 0) {
                    feedback.innerHTML = `✓ ${uploaded - skipped} new file(s) added! (${skipped} duplicate(s) skipped)`;
                } else {
                    feedback.innerHTML = `✓ ${uploaded} file(s) added to the family archive! Refreshing gallery...`;
                }

                // Clear the input so they can upload more
                photoInput.value = '';

                // Refresh the gallery to show new photos
                setTimeout(async () => {
                    await loadGallery();
                    if (skipped > 0) {
                        feedback.innerHTML = `✓ ${uploaded - skipped} new file(s) added! (${skipped} already in archive)`;
                    } else {
                        feedback.innerHTML = `✓ ${uploaded} file(s) added! <span style="color: #4ade80;">Gallery updated ↑</span>`;
                    }
                }, 2000);

            } catch (error) {
                console.error('Upload error:', error);
                feedback.style.color = '#c44';
                feedback.innerText = `Upload failed: ${error.message}. Please try again.`;
            }
        });

        // Sticky Nav Logic
        const nav = document.getElementById('sticky-nav');
        const hero = document.getElementById('home');
        
        const navObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (!entry.isIntersecting) {
                    nav.classList.add('visible');
                } else {
                    nav.classList.remove('visible');
                }
            });
        }, { threshold: 0.15 }); // Trigger when 15% of hero is still visible (scrolling down)
        
        navObserver.observe(hero);

        // Accordion Logic
        function toggleAccordion(element) {
            const item = element.parentElement;
            const content = item.querySelector('.accordion-content');
            
            // Close others (optional, but nice for this layout)
            document.querySelectorAll('.accordion-item').forEach(acc => {
                if (acc !== item && acc.classList.contains('active')) {
                    acc.classList.remove('active');
                    acc.querySelector('.accordion-content').style.maxHeight = null;
                }
            });

            item.classList.toggle('active');
            
            if (item.classList.contains('active')) {
                content.style.maxHeight = content.scrollHeight + "px";
            } else {
                content.style.maxHeight = null;
            }
        }
    </script>
</body>
</html>